<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Color Signal â€“ E2EE Dashboard</title>

<style>
    body {
        margin: 0;
        padding: 0;
        background: #0d0d0d;
        color: #fff;
        font-family: Arial;
        height: 100vh;
        display: flex;
    }

    /* GRID LAYOUT */
    .layout {
        display: grid;
        grid-template-columns: 330px 1fr;
        width: 100%;
        height: 100%;
    }

    /* LEFT PANEL */
    .left {
        background: #161616;
        padding: 20px;
        border-right: 2px solid #222;
        display: flex;
        flex-direction: column;
    }

    h2 {
        text-align: center;
        margin: 0 0 15px;
        color: #58a6ff;
    }

    label { font-size: 14px; font-weight: bold; }

    input {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        border: none;
        background: #222;
        color: #fff;
        margin-bottom: 10px;
    }

    button {
        padding: 10px;
        border: none;
        background: #0066ff;
        border-radius: 6px;
        color: #fff;
        cursor: pointer;
        margin-bottom: 20px;
        font-size: 15px;
    }

    button:hover { background: #0052d6; }

    .colors {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 10px;
    }

    .color-box {
        height: 70px;
        border-radius: 10px;
        cursor: pointer;
        transition: 0.2s;
        border: 2px solid #0005;
    }

    .color-box:hover {
        transform: scale(1.1);
    }

    #selectedColor {
        margin-top: 20px;
        padding: 15px;
        background: #1e1e1e;
        border-radius: 10px;
        text-align: center;
        font-size: 16px;
        border: 1px solid #333;
    }

    /* RIGHT PANEL */
    .right {
        padding: 20px;
        overflow-y: auto;
    }

    .log-entry {
        background: #1f1f1f;
        padding: 12px;
        border-radius: 10px;
        border-left: 8px solid;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }

    .circle {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        margin-right: 15px;
    }

    .entry-text {
        font-size: 14px;
    }

    .freq-box {
        margin-top: 25px;
        background: #181818;
        padding: 15px;
        border-radius: 10px;
    }

    .freq-row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .freq-circle {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        margin-right: 10px;
    }
</style>
</head>

<body>

<div class="layout">

    <!-- LEFT PANEL -->
    <div class="left">

        <h2>ðŸŽ¨ Color Signal</h2>

        <label>Room ID</label>
        <input id="roomId" placeholder="room1">

        <label>User ID</label>
        <input id="userId" placeholder="alice / bob">

        <button onclick="joinRoom()">Join Room</button>

        <h3>Choose Color:</h3>

        <div class="colors">
            <div class="color-box" style="background:#ff4757" onclick="sendColor('#ff4757')"></div>
            <div class="color-box" style="background:#1e90ff" onclick="sendColor('#1e90ff')"></div>
            <div class="color-box" style="background:#2ed573" onclick="sendColor('#2ed573')"></div>
            <div class="color-box" style="background:#ffa502" onclick="sendColor('#ffa502')"></div>
            <div class="color-box" style="background:#5352ed" onclick="sendColor('#5352ed')"></div>
            <div class="color-box" style="background:#ff6b81" onclick="sendColor('#ff6b81')"></div>
        </div>

        <div id="selectedColor">Selected: None</div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="right">
        <h2>ðŸ“Š Color Activity Panel</h2>

        <div id="logList"></div>

        <div class="freq-box">
            <h3>Color Frequency</h3>
            <div id="freqList"></div>
        </div>
    </div>
</div>

<script>
const SERVER = "https://fortunate-strength-production.up.railway.app";


let myKeyPair = null;
let partnerKey = null;
let lastMessageId = 0;
let frequency = {};

/* SHORTCUT */
function id(x){ return document.getElementById(x); }

/* JOIN ROOM */
async function joinRoom() {
    const roomId = id("roomId").value;
    const userId = id("userId").value;

    if (!roomId || !userId) return alert("Enter both Room ID & User ID!");

    // Generate RSA keys
    myKeyPair = await crypto.subtle.generateKey(
        {
            name:"RSA-OAEP",
            modulusLength:2048,
            publicExponent:new Uint8Array([1,0,1]),
            hash:"SHA-256"
        },
        true,
        ["encrypt","decrypt"]
    );

    const publicJwk = await crypto.subtle.exportKey("jwk", myKeyPair.publicKey);

    await fetch(`${SERVER}/register`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
            roomId, userId, publicKeyJwk: publicJwk
        })
    });

    pollPartnerKey();
    pollMessages();

    alert("Joined successfully!");
}

/* SEND COLOR (RSA Encrypted) */
async function sendColor(hex) {
    if (!partnerKey) return alert("Waiting for partner...");

    id("selectedColor").style.background = hex;
    id("selectedColor").textContent = "Selected: " + hex;

    const encoded = new TextEncoder().encode(hex);
    const encrypted = await crypto.subtle.encrypt({name:"RSA-OAEP"}, partnerKey, encoded);

    const b64 = btoa(String.fromCharCode(...new Uint8Array(encrypted)));

    await fetch(`${SERVER}/send`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
            roomId: id("roomId").value,
            senderId: id("userId").value,
            ciphertext: b64
        })
    });
}

/* GET PARTNER KEY */
async function pollPartnerKey() {
    setInterval(async () => {
        const res = await fetch(
            `${SERVER}/partnerKey?roomId=${id("roomId").value}&userId=${id("userId").value}`
        );

        const data = await res.json();

        if (data.partnerKeyJwk && !partnerKey) {
            partnerKey = await crypto.subtle.importKey(
                "jwk",
                data.partnerKeyJwk,
                {name:"RSA-OAEP", hash:"SHA-256"},
                true,
                ["encrypt"]
            );
        }
    }, 1500);
}

/* GET LIVE COLOR MESSAGES */
async function pollMessages() {
    setInterval(async () => {
        const res = await fetch(
            `${SERVER}/messages?roomId=${id("roomId").value}&userId=${id("userId").value}&sinceId=${lastMessageId}`
        );

        const data = await res.json();

        for (const m of data.messages) {
            lastMessageId = m.id;
            const bytes = Uint8Array.from(atob(m.ciphertext), c => c.charCodeAt(0));
            const decrypted = await crypto.subtle.decrypt(
                {name:"RSA-OAEP"},
                myKeyPair.privateKey,
                bytes
            );
            const color = new TextDecoder().decode(decrypted);

            addLog(color);
            updateFrequency(color);
        }
    }, 1000);
}

/* ADD ENTRY TO RIGHT-SIDE LOG */
function addLog(color) {
    const log = document.createElement("div");
    log.className = "log-entry";
    log.style.borderLeftColor = color;

    log.innerHTML = `
        <div class="circle" style="background:${color}"></div>
        <div class="entry-text">
            <b>${color}</b><br>
            ${new Date().toLocaleTimeString()}
        </div>
    `;

    id("logList").prepend(log);
}

/* UPDATE FREQUENCY PANEL */
function updateFrequency(color) {
    if (!frequency[color]) frequency[color] = 0;
    frequency[color]++;

    const container = id("freqList");
    container.innerHTML = "";

    Object.keys(frequency).forEach(c => {
        const row = document.createElement("div");
        row.className = "freq-row";

        row.innerHTML = `
            <div class="freq-circle" style="background:${c}"></div>
            <span>${c}: ${frequency[c]} times</span>
        `;
        container.appendChild(row);
    });
}
</script>

</body>
</html>
